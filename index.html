<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>蜴滉ｾ｡繧｢繝励Μ・・VP・・/title>
    <!-- Tailwind CDN・・IT・・-->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD + ReactDOM 18 UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone・医ヶ繝ｩ繧ｦ繧ｶ縺ｧJSX繧貞､画鋤・・-->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      .fruit-card .font-medium { display: none; }
    </style>
  </head>
  <body class="bg-neutral-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      // ===== 縺薙％縺九ｉ縺ゅ↑縺溘・繧｢繝励Μ・・mport/export 縺ｪ縺礼沿・・=====
      const { useEffect, useMemo, useState } = React;

      const uid = () => Math.random().toString(36).slice(2);
      const rY = (v) => Math.round(v);

      function usePersistentState(key, initial) {
        const [state, setState] = useState(() => {
          try {
            const raw = localStorage.getItem(key);
            if (raw) return JSON.parse(raw);
          } catch {}
          return initial;
        });
        useEffect(() => {
          localStorage.setItem(key, JSON.stringify(state));
        }, [key, state]);
        return [state, setState];
      }

      const EDIBLE_FIXED = {
        "縺・■縺・: 0.9,
        "縺ｶ縺ｩ縺・: 0.87,
        "繧ｷ繝｣繧､繝ｳ繝槭せ繧ｫ繝・ヨ": 0.87,
        "蟾ｨ蟲ｰ": 0.87,
        "繧ｯ繧､繝ｼ繝ｳ繝ｫ繝ｼ繧ｸ繝･": 0.87,
        "繧ｯ繧､繝ｼ繝ｳ繝九・繝・: 0.87,
        "繝翫ぎ繝弱ヱ繝ｼ繝励Ν": 0.87,
        "繝悶Ν繝ｼ繝吶Μ繝ｼ": 0.98,
        "繝悶Λ繝・け繝吶Μ繝ｼ": 0.9,
        "繝√ぉ繝ｪ繝ｼ": 0.95,
        "繧｢繝｡繝ｪ繧ｫ繝ｳ繝√ぉ繝ｪ繝ｼ": 0.95,
        "繧ゅｂ": 0.93,
        "譯・: 0.93,
        "繝阪け繧ｿ繝ｪ繝ｳ": 0.95,
        "繝｡繝ｭ繝ｳ": 0.6,
        "繝ｬ繝｢繝ｳ": 0.45,
        "譴ｨ": 0.9,
        "繧ｫ繧ｷ繧ｹ": 0.98,
        "繝槭せ繧ｫ繝ｫ繝昴・繝・: 1.0,
        "繧ｯ繝ｪ繝ｼ繝繝√・繧ｺ": 1.0
      };

      const initialIngredients = [
        { id: "granola", name: "繧ｰ繝ｩ繝弱・繝ｩ", category: "granola", pricePerKg: 1921 },
        { id: "whip", name: "繝帙う繝・・", category: "cream", pricePerKg: 871 }
      ];

      const shippingPerKg = (f) =>
        (f.shippingCostTotal && f.shipmentWeightKg)
          ? rY(f.shippingCostTotal / f.shipmentWeightKg)
          : 0;

      const effectivePricePerKg = (f) =>
        (f.contractPricePerKg || 0) + shippingPerKg(f);

      const edibleEffPerKg = (f) => {
        const ratio = f.edibleRatio ?? EDIBLE_FIXED[f.fruitName] ?? 1;
        const eff = effectivePricePerKg(f);
        return rY(eff / (ratio > 0 ? ratio : 1));
      };

      const basePerG = (b) =>
        b.lines.reduce((s, l) => s + (l.pricePerKg / 1000) * l.qtyG, 0) /
        (b.finishedWeightG || 1);

      const initialBases = [
        {
          id: uid(),
          name: "繝輔Ο繝ｼ繧ｺ繝ｳ繝ｨ繝ｼ繧ｰ繝ｫ繝・,
          finishedWeightG: 2872.088,
          lines: [
            { id: uid(), name: "陷り惧", pricePerKg: 1375, qtyG: 42 },
            { id: uid(), name: "邊我ｹｳ", pricePerKg: 1097, qtyG: 126, isYogurtComponent: true },
            { id: uid(), name: "逕倥∩謌仙・", pricePerKg: 1079, qtyG: 730 },
            { id: uid(), name: "迚帑ｹｳ", pricePerKg: 209, qtyG: 1974, isYogurtComponent: true },
            { id: uid(), name: "荵ｳ驟ｸ闖・, pricePerKg: 252000, qtyG: 0.088, isYogurtComponent: true }
          ]
        },
        { id: uid(), name: "繝ｨ繝ｼ繧ｰ繝ｫ繝・, finishedWeightG: 2100.088, lines: [] },
        { id: uid(), name: "繧ｮ繝ｪ繧ｷ繝｣繝ｨ繝ｼ繧ｰ繝ｫ繝・, finishedWeightG: 1000, lines: [] }
      ];

      const initialFruits = [
        { id: uid(), supplier: "豐｢逕ｰ蝠・ｺ・, fruitName: "繝悶Λ繝・け繝吶Μ繝ｼ", contractPricePerKg: 1350, shippingCostTotal: 2180, shipmentWeightKg: 15, edibleRatio: EDIBLE_FIXED["繝悶Λ繝・け繝吶Μ繝ｼ"] },
        { id: uid(), supplier: "", fruitName: "蜈ｫ繝ｶ蟯ｳ繝悶Ν繝ｼ繝吶Μ繝ｼ", contractPricePerKg: 1500, shippingCostTotal: 1500, shipmentWeightKg: 10, edibleRatio: EDIBLE_FIXED["繝悶Ν繝ｼ繝吶Μ繝ｼ"] },
        { id: uid(), supplier: "豐｢逕ｰ蝠・ｺ・, fruitName: "繧ｯ繝ｩ繝ｳ繝吶Μ繝ｼ", contractPricePerKg: 1340, shippingCostTotal: 2180, shipmentWeightKg: 15, edibleRatio: 0.98 },
        { id: uid(), supplier: "鬧偵Ω譬ｹ縺・■縺泌恍", fruitName: "縺・■縺・, variety: "邏・⊇縺｣縺ｺ", contractPricePerKg: 1200, shippingCostTotal: 1200, shipmentWeightKg: 10, edibleRatio: EDIBLE_FIXED["縺・■縺・] },
        { id: uid(), supplier: "369FARM", fruitName: "縺輔・縺ｮ繝ｬ繝｢繝ｳ", contractPricePerKg: 1000, shippingCostTotal: 1431, shipmentWeightKg: 16, edibleRatio: EDIBLE_FIXED["繝ｬ繝｢繝ｳ"] },
        { id: uid(), supplier: "蠑伜燕蛟牙ｺｫ", fruitName: "蠑伜燕繧ｫ繧ｷ繧ｹ", contractPricePerKg: 1458, shippingCostTotal: 1580, shipmentWeightKg: 16, edibleRatio: EDIBLE_FIXED["繧ｫ繧ｷ繧ｹ"] },
        { id: uid(), supplier: "鬧偵Ω譬ｹ縺・■縺泌恍", fruitName: "逕溘＞縺｡縺・, variety: "邏・⊇縺｣縺ｺ", contractPricePerKg: 1600, shippingCostTotal: 1500, shipmentWeightKg: 4.8, edibleRatio: EDIBLE_FIXED["縺・■縺・] },
        { id: uid(), supplier: "豐｢逕ｰ蝠・ｺ・, fruitName: "繧｢繝｡繝ｪ繧ｫ繝ｳ繝√ぉ繝ｪ繝ｼ", contractPricePerKg: 1750, shippingCostTotal: 2180, shipmentWeightKg: 15, edibleRatio: EDIBLE_FIXED["繧｢繝｡繝ｪ繧ｫ繝ｳ繝√ぉ繝ｪ繝ｼ"] },
        { id: uid(), supplier: "繧ｦ繧ｨ繝繝ｩ繝｡繝ｭ繝ｳ繝輔ぃ繝ｼ繝", fruitName: "繧ｿ繧ｫ繝溘Γ繝ｭ繝ｳ", contractPricePerKg: 500, shippingCostTotal: 1606, shipmentWeightKg: 10, edibleRatio: EDIBLE_FIXED["繝｡繝ｭ繝ｳ"] },
        { id: uid(), supplier: "荳ｭ譚題ｾｲ蝨・, fruitName: "縺ｶ縺ｩ縺・, variety: "蟾ｨ蟲ｰ", contractPricePerKg: 2125, shippingCostTotal: 2500, shipmentWeightKg: 8, edibleRatio: EDIBLE_FIXED["蟾ｨ蟲ｰ"] },
        { id: uid(), supplier: "荳ｭ譚題ｾｲ蝨・, fruitName: "縺ｶ縺ｩ縺・, variety: "繧ｯ繧､繝ｼ繝ｳ繝ｫ繝ｼ繧ｸ繝･", contractPricePerKg: 2500, shippingCostTotal: 2000, shipmentWeightKg: 8, edibleRatio: EDIBLE_FIXED["繧ｯ繧､繝ｼ繝ｳ繝ｫ繝ｼ繧ｸ繝･"] },
        { id: uid(), supplier: "荳ｭ譚題ｾｲ蝨・, fruitName: "縺ｶ縺ｩ縺・, variety: "繝翫ぎ繝弱ヱ繝ｼ繝励Ν", contractPricePerKg: 2500, shippingCostTotal: 2000, shipmentWeightKg: 8, edibleRatio: EDIBLE_FIXED["繝翫ぎ繝弱ヱ繝ｼ繝励Ν"] },
        { id: uid(), supplier: "荳ｭ譚題ｾｲ蝨・, fruitName: "縺ｶ縺ｩ縺・, variety: "繧ｯ繧､繝ｼ繝ｳ繝九・繝・, contractPricePerKg: 2500, shippingCostTotal: 2000, shipmentWeightKg: 8, edibleRatio: EDIBLE_FIXED["繧ｯ繧､繝ｼ繝ｳ繝九・繝・] },
        { id: uid(), supplier: "荳ｭ譚題ｾｲ蝨・, fruitName: "縺ｶ縺ｩ縺・, variety: "繧ｷ繝｣繧､繝ｳ繝槭せ繧ｫ繝・ヨ", contractPricePerKg: 2500, shippingCostTotal: 2000, shipmentWeightKg: 8, edibleRatio: EDIBLE_FIXED["繧ｷ繝｣繧､繝ｳ繝槭せ繧ｫ繝・ヨ"] },
        { id: uid(), supplier: "荳螳溷ｱ・, fruitName: "縺ｶ縺ｩ縺・, variety: "蟾ｨ蟲ｰ", contractPricePerKg: 1000, shippingCostTotal: 0, edibleRatio: EDIBLE_FIXED["蟾ｨ蟲ｰ"] },
        { id: uid(), supplier: "荳螳溷ｱ・, fruitName: "譯・, contractPricePerKg: 1142, shippingCostTotal: 0, edibleRatio: EDIBLE_FIXED["譯・] },
        { id: uid(), supplier: "繝輔Ν繝ｼ繝・ｷ･謌ｿ繧ｿ繝ｳ繧ｶ繝ｯ", fruitName: "繝阪け繧ｿ繝ｪ繝ｳ", contractPricePerKg: 1400, shippingCostTotal: 1000, shipmentWeightKg: 5, edibleRatio: EDIBLE_FIXED["繝阪け繧ｿ繝ｪ繝ｳ"] },
        { id: uid(), supplier: "蟆城㍽霎ｲ蝨・, fruitName: "縺ｶ縺ｩ縺・, variety: "BK繧ｷ繝ｼ繝峨Ξ繧ｹ", contractPricePerKg: 1400, shippingCostTotal: 1800, shipmentWeightKg: 10, edibleRatio: EDIBLE_FIXED["縺ｶ縺ｩ縺・] },
        { id: uid(), supplier: "蟆城㍽霎ｲ蝨・, fruitName: "縺ｶ縺ｩ縺・, variety: "蟾ｨ蟲ｰ", contractPricePerKg: 1000, shippingCostTotal: 1800, shipmentWeightKg: 10, edibleRatio: EDIBLE_FIXED["蟾ｨ蟲ｰ"] },
        { id: uid(), supplier: "荳ｭ豐｢荵ｳ讌ｭ", fruitName: "繝槭せ繧ｫ繝ｫ繝昴・繝・, contractPricePerKg: 2580, shippingCostTotal: 0, edibleRatio: EDIBLE_FIXED["繝槭せ繧ｫ繝ｫ繝昴・繝・] },
        { id: uid(), supplier: "繝輔ぅ繝ｩ繝・Ν繝輔ぅ繧｢", fruitName: "繧ｯ繝ｪ繝ｼ繝繝√・繧ｺ", contractPricePerKg: 1430, shippingCostTotal: 0, edibleRatio: EDIBLE_FIXED["繧ｯ繝ｪ繝ｼ繝繝√・繧ｺ"] }
      ];

      function Card({ title, value, subtitle }) {
        return (
          <div className="bg-white rounded-2xl p-4 shadow-sm">
            <div className="text-xs opacity-70">{title}</div>
            <div className="text-xl font-bold mt-1">{value}</div>
            {subtitle && <div className="text-xs opacity-60 mt-1">{subtitle}</div>}
          </div>
        );
      }

      function FruitList({ fruits, setFruits, includeShipping, fyPerG }) {
        const [q, setQ] = useState("");
        const [open, setOpen] = useState(false);
        const [editing, setEditing] = useState(null);
        const [form, setForm] = useState({ supplier: "", fruitName: "", variety: "", contract: "", shipTotal: "", shipKg: "", edible: "" });
        const list = fruits.filter((f) => `${f.supplier} ${f.fruitName} ${f.variety ?? ""}`.includes(q));
        const toNum = (s) => { const v = Number(s); return isFinite(v) ? v : undefined; };
        // 譌｢螳壹ヶ繝ｬ繝ｳ繝蛾㍼・・繧ｵ繧､繧ｺ譎ゅ・譫懃黄g・・        const blendDefault = (f) => {
          const name = f?.fruitName || "";
          const variety = f?.variety || "";
          if (name.includes("蜈ｫ繝ｶ蟯ｳ繝悶Ν繝ｼ繝吶Μ繝ｼ")) return 33;
          if (name.includes("繧ｯ繝ｩ繝ｳ繝吶Μ繝ｼ")) return 20;
          if (name.includes("繧｢繝｡繝ｪ繧ｫ繝ｳ繝√ぉ繝ｪ繝ｼ")) return 40;
          if (name.includes("繧ｿ繧ｫ繝溘Γ繝ｭ繝ｳ")) return 37;
          if (name.includes("繝阪け繧ｿ繝ｪ繝ｳ")) return 37;
          if (name.includes("繝ｬ繝｢繝ｳ")) return 15;
          if (name.includes("蠑伜燕繧ｫ繧ｷ繧ｹ") || name.includes("繧ｫ繧ｷ繧ｹ")) return 15;
          if (name.includes("繝槭せ繧ｫ繝ｫ繝・)) return 20;
          if (name.includes("繧ｯ繝ｪ繝ｼ繝繝・)) return 17;
          if (name.includes("繧ゅｂ") || name.includes("譯・)) return 40;
          if (
            name.includes("縺ｶ縺ｩ") ||
            variety.includes("蟾ｨ蟲ｰ") || name.includes("蟾ｨ蟲ｰ") ||
            variety.includes("繧ｷ繝｣繧､繝ｳ") || name.includes("繧ｷ繝｣繧､繝ｳ") ||
            variety.includes("繝翫ぎ繝・) || name.includes("繝翫ぎ繝・) ||
            variety.includes("繧ｯ繧､繝ｼ繝ｳ") || name.includes("繧ｯ繧､繝ｼ繝ｳ")
          ) return 40;
          // 繝悶Λ繝・け繝吶Μ繝ｼ邉ｻ・医ヶ繝ｫ繝ｼ/繧ｯ繝ｩ繝ｳ/繧ｫ繧ｷ繧ｹ髯､螟厄ｼ・          if (name.includes("繝吶Μ繝ｼ") && !name.includes("繝悶Ν繝ｼ") && !name.includes("繧ｯ繝ｩ繝ｳ") && !name.includes("繧ｫ繧ｷ繧ｹ")) return 30;
          // 縺・■縺皮ｳｻ
          if (name.includes("縺・■") || name.includes("闍ｺ")) return 35;
          return undefined;
        };
        const openNew = () => { setEditing(null); setForm({ supplier: "", fruitName: "", variety: "", contract: "", shipTotal: "", shipKg: "", edible: "" }); setOpen(true); };
        const openEdit = (f) => { setEditing(f); setForm({ supplier: f.supplier || "", fruitName: f.fruitName || "", variety: f.variety || "", contract: String(f.contractPricePerKg ?? ""), shipTotal: String(f.shippingCostTotal ?? ""), shipKg: String(f.shipmentWeightKg ?? ""), edible: String(f.edibleRatio ?? "") }); setOpen(true); };
        const save = () => {
          const patch = {
            id: editing?.id ?? uid(),
            supplier: form.supplier.trim(),
            fruitName: form.fruitName.trim(),
            variety: form.variety.trim() || undefined,
            contractPricePerKg: Number(form.contract || 0),
            shippingCostTotal: toNum(form.shipTotal),
            shipmentWeightKg: toNum(form.shipKg),
            edibleRatio: toNum(form.edible) ?? (EDIBLE_FIXED[form.fruitName] ?? 1)
          };
          if (editing) {
            setFruits(fruits.map((x) => (x.id === editing.id ? { ...x, ...patch } : x)));
          } else {
            setFruits([patch, ...fruits]);
          }
          setOpen(false);
        };
        const removeItem = () => { if (!editing) return; setFruits(fruits.filter((x) => x.id !== editing.id)); setOpen(false); };

        return (
          <div className="px-4 pb-10">
            <div className="mb-2 flex items-center gap-2">
              <input className="border rounded-xl p-2 w-full" placeholder="霎ｲ螳ｶ/譫懃黄/蜩∫ｨｮ縺ｧ讀懃ｴ｢" value={q} onChange={(e) => setQ(e.target.value)} />
              <button onClick={openNew} className="px-3 py-2 bg-emerald-600 text-white rounded-xl text-sm">譁ｰ隕剰ｿｽ蜉</button>
            </div>
            <div className="space-y-2">
              {list.map((f) => {
                const effKg = (f.contractPricePerKg || 0) + (includeShipping ? shippingPerKg(f) : 0);
                const edibleKg = rY(effKg / ((f.edibleRatio && f.edibleRatio > 0) ? f.edibleRatio : 1));
                const fruitBlendG = (f.blendFruitG ?? blendDefault(f) ?? 35);
                const fyBlendG = Math.max(0, 100 - fruitBlendG);
                const sCost = rY((edibleKg / 1000) * fruitBlendG + (fyPerG || 0) * fyBlendG);
                const mCost = rY(1.4 * ((edibleKg / 1000) * fruitBlendG + (fyPerG || 0) * fyBlendG));
                return (
                    <div key={f.id} className="bg-white rounded-2xl p-3 shadow-sm fruit-card">
                    <div className="flex items-start justify-between">
                      <div>
                        <div className="font-semibold">{f.supplier ? `${f.supplier}・彖 : ""}{f.fruitName}{f.variety ? `・・{f.variety}・荏 : ""}</div>
                        <div className="text-sm mt-1">
                          <span className="font-medium">螳溯ｳｪ ﾂ･/kg・亥庄鬟滄←逕ｨ・会ｼ・/span>
                          <span className="font-extrabold">・･{edibleKg.toLocaleString()}</span>
                          <span className="ml-3 text-xs opacity-70">FY繝輔Ξ繝ｼ繝舌・ S:・･{sCost.toLocaleString()} / M:・･{mCost.toLocaleString()}</span>
                        </div>
                        <div className="text-xs opacity-70 mt-1">螂醍ｴ・ｿ･{(f.contractPricePerKg || 0).toLocaleString()} /kg・憺∵侭・･{includeShipping ? shippingPerKg(f) : 0} /kg・懷庄鬟・{f.edibleRatio ?? 1}</div>
                        {/* 1g・亥庄鬟滄←逕ｨ・芽｡ｨ遉ｺ縺ｯ髱櫁｡ｨ遉ｺ縺ｫ縺励∪縺励◆ */}
                      </div>
                      <button onClick={() => openEdit(f)} className="px-3 py-1 bg-neutral-100 rounded-lg text-sm">邱ｨ髮・/button>
                    </div>
                  </div>
                );
              })}
            </div>

            <Modal open={open} onClose={() => setOpen(false)} title={editing ? "譫懃黄繧堤ｷｨ髮・ : "譫懃黄繧定ｿｽ蜉"}>
              <div className="grid gap-2 text-sm">
                <label>莉募・蜈・input className="border rounded-xl p-2 w-full" value={form.supplier} onChange={(e) => setForm({ ...form, supplier: e.target.value })} /></label>
                <label>譫懃黄蜷・input className="border rounded-xl p-2 w-full" value={form.fruitName} onChange={(e) => setForm({ ...form, fruitName: e.target.value })} /></label>
                <label>蜩∫ｨｮ・井ｻｻ諢擾ｼ・input className="border rounded-xl p-2 w-full" value={form.variety} onChange={(e) => setForm({ ...form, variety: e.target.value })} /></label>
                <label>螂醍ｴ・ｾ｡譬ｼ(蜀・kg)<input type="number" className="border rounded-xl p-2 w-full" value={form.contract} onChange={(e) => setForm({ ...form, contract: e.target.value })} /></label>
                <div className="grid grid-cols-2 gap-2">
                  <label>騾∵侭邱城｡・蜀・<input type="number" className="border rounded-xl p-2 w-full" value={form.shipTotal} onChange={(e) => setForm({ ...form, shipTotal: e.target.value })} /></label>
                  <label>驟埼・㍾驥・kg)<input type="number" className="border rounded-xl p-2 w-full" value={form.shipKg} onChange={(e) => setForm({ ...form, shipKg: e.target.value })} /></label>
                </div>
                <label>蜿ｯ鬟滄Κ邇・0縲・)<input type="number" step="0.01" className="border rounded-xl p-2 w-full" value={form.edible} onChange={(e) => setForm({ ...form, edible: e.target.value })} /></label>
                <div className="flex justify-between items-center gap-2 mt-2">
                  {editing && <button onClick={removeItem} className="px-3 py-2 rounded-xl bg-red-600 text-white">蜑企勁</button>}
                  <div className="ml-auto flex gap-2">
                    <button onClick={() => setOpen(false)} className="px-3 py-2 rounded-xl bg-neutral-100">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
                    <button onClick={save} className="px-3 py-2 rounded-xl bg-emerald-600 text-white">菫晏ｭ・/button>
                  </div>
                </div>
              </div>
            </Modal>
          </div>
        );
      }

      function BaseEditor({ bases, setBases, fyKg }) {
        const fy = bases.find((b) => b.name === "繝輔Ο繝ｼ繧ｺ繝ｳ繝ｨ繝ｼ繧ｰ繝ｫ繝・);
        const updateLine = (id, patch) => {
          const next = { ...fy, lines: fy.lines.map((l) => (l.id === id ? { ...l, ...patch } : l)) };
          setBases(bases.map((b) => (b.id === fy.id ? next : b)));
        };
        const add = () => {
          const name = prompt("譚先侭蜷・);
          if (!name) return;
          const price = Number(prompt("蜊倅ｾ｡(蜀・kg)", "0") || 0);
          const qty = Number(prompt("謨ｰ驥・g)", "0") || 0);
          const yo = confirm("繝ｨ繝ｼ繧ｰ繝ｫ繝域・蛻・↓蜷ｫ繧√ｋ・・);
          const next = { ...fy, lines: [...fy.lines, { id: uid(), name, pricePerKg: price, qtyG: qty, isYogurtComponent: yo }] };
          setBases(bases.map((b) => (b.id === fy.id ? next : b)));
        };
        const del = (id) => {
          const next = { ...fy, lines: fy.lines.filter((l) => l.id !== id) };
          setBases(bases.map((b) => (b.id === fy.id ? next : b)));
        };

        // 繝ｨ繝ｼ繧ｰ繝ｫ繝域・蛻・・縺ｿ縺ｮ蜴滉ｾ｡・・g縺ゅ◆繧奇ｼ・        const yogurtCostTotal = (fy?.lines || []).reduce(
          (sum, l) => sum + (l.isYogurtComponent ? (l.pricePerKg / 1000) * (l.qtyG || 0) : 0),
          0
        );
        const yogurtWeightG = (fy?.lines || []).reduce(
          (sum, l) => sum + (l.isYogurtComponent ? (l.qtyG || 0) : 0),
          0
        );
        const yogurtPerG = yogurtWeightG > 0 ? yogurtCostTotal / yogurtWeightG : 0;
        const yogurtKg = rY(yogurtPerG * 1000);

        return (
          <div className="px-4 pb-10">
            <div className="bg-white rounded-2xl p-4 shadow-sm">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">FY驟榊粋・按･/kg・夲ｿ･{fyKg.toLocaleString()}・・/div>
                <button onClick={add} className="px-3 py-1 bg-emerald-600 text-white rounded-lg text-sm">陦瑚ｿｽ蜉</button>
              </div>
              <div className="text-sm text-neutral-600 mb-2">繝ｨ繝ｼ繧ｰ繝ｫ繝域・蛻・ﾂ･/kg ・･{yogurtKg.toLocaleString()}</div>
              <div className="space-y-2">
                {fy.lines.map((l) => (
                  <div key={l.id} className="grid grid-cols-10 gap-2 items-center">
                    <input className="col-span-3 border rounded-xl p-2" value={l.name} onChange={(e) => updateLine(l.id, { name: e.target.value })} />
                    <input type="number" className="col-span-2 border rounded-xl p-2" value={l.pricePerKg} onChange={(e) => updateLine(l.id, { pricePerKg: Number(e.target.value) })} />
                    <input type="number" className="col-span-2 border rounded-xl p-2" value={l.qtyG} onChange={(e) => updateLine(l.id, { qtyG: Number(e.target.value) })} />
                    <label className="col-span-2 text-sm flex items-center gap-2">
                      <input type="checkbox" checked={!!l.isYogurtComponent} onChange={(e) => updateLine(l.id, { isYogurtComponent: e.target.checked })} />
                      繝ｨ繝ｼ繧ｰ繝ｫ繝域・蛻・                    </label>
                    <button className="col-span-1 text-sm text-red-600" onClick={() => del(l.id)}>蜑企勁</button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function MenuEditor({ fruits, fyPerG, ingredients, items, setItems, cat, setCat }) {
        const [open, setOpen] = useState(false);
        const [name, setName] = useState("");
        const [menuEditOpen, setMenuEditOpen] = useState(false);
        const [menuEditing, setMenuEditing] = useState(null);
        const [menuEditName, setMenuEditName] = useState("");

        const create = () => {
          if (!name) return;
          const id = uid();
          const lines = cat === "逕溘・縺帙す繝ｪ繝ｼ繧ｺ"
            ? [{ id: uid(), type: "fruit", qtyG: 60 }, { id: uid(), type: "base", qtyG: 100 }]
            : [];
          setItems([...items, { id, name, category: cat, lines }]);
          setName("");
          setOpen(false);
        };

        const UnifiedDD = ({ value, onChange }) => {
          const selected = value || "";
          return (
            <select className="border rounded-xl p-2 w-full" value={selected} onChange={(e) => onChange(e.target.value)}>
              <option value="">譚先侭繧帝∈謚・/option>
              <optgroup label="譫懃黄">
                {fruits.map((f) => (
                  <option key={"f:" + f.id} value={"f:" + f.id}>
                    {`${f.supplier ? f.supplier + "・・ : ""}${f.fruitName}${f.variety ? `・・{f.variety}・荏 : ""}`}
                  </option>
                ))}
              </optgroup>
              <optgroup label="縺昴・莉・>
                {ingredients.map((i) => (
                  <option key={"i:" + i.id} value={"i:" + i.id}>
                    {`${i.name}・茨ｿ･${i.pricePerKg}/kg・荏}
                  </option>
                ))}
              </optgroup>
            </select>
          );
        };

        const perG = (f) => edibleEffPerKg(f) / 1000;

        const lineCost = (l) => {
          if (l.type === "base") return rY(fyPerG * (l.qtyG || 0));
          if (l.type === "fruit") {
            const f = fruits.find((z) => z.id === l.refId);
            if (!f) return 0;
            return rY(perG(f) * (l.qtyG || 0));
          }
          const ing = ingredients.find((z) => z.id === l.refId);
          if (!ing) return 0;
          return rY((ing.pricePerKg / 1000) * (l.qtyG || 0));
        };

        const menuCost = (m) => rY(m.lines.reduce((s, l) => s + lineCost(l), 0));

        const addTypedLine = (m) => {
          const type = (prompt("陦後ち繧､繝暦ｼ・ruit / base / ingredient / sauce / cream / granola / topping / container・・, "fruit") || "fruit");
          const qty = Number(prompt("謨ｰ驥充g]", "0") || 0);
          const newLine = { id: uid(), type, qtyG: qty };
          setItems(items.map((x) => (x.id === m.id ? { ...x, lines: [...x.lines, newLine] } : x)));
        };

        const composedValue = (l) => {
          if (!l.refId) return "";
          if (l.type === "fruit") return "f:" + l.refId;
          if (l.type === "base") return "";
          return "i:" + l.refId;
        };

        const handleSelectChange = (m, l, val) => {
          if (!val) {
            setItems(items.map((x) => (x.id === m.id ? { ...x, lines: x.lines.map((a) => (a.id === l.id ? { ...a, refId: undefined } : a)) } : x)));
            return;
          }
          const [prefix, id] = val.split(":");
          const next = items.map((x) =>
            x.id === m.id
              ? {
                  ...x,
                  lines: x.lines.map((a) =>
                    a.id === l.id ? { ...a, refId: id, type: prefix === "f" ? "fruit" : a.type === "base" ? "base" : "ingredient" } : a
                  )
                }
              : x
          );
          setItems(next);
        };

        const openEditMenu = (m) => { setMenuEditing(m); setMenuEditName(m.name); setMenuEditOpen(true); };
        const saveEditMenu = () => { if (!menuEditing) return; setItems(items.map((x) => (x.id === menuEditing.id ? { ...x, name: menuEditName } : x))); setMenuEditOpen(false); };
        const removeMenu = (m) => { setItems(items.filter((x) => x.id !== m.id)); };

        return (
          <div className="px-4 pb-16">
            <div className="flex gap-2 mb-3">
              {["繝代ヵ繧ｧ", "逕溘・縺帙す繝ｪ繝ｼ繧ｺ", "繝輔Ν繝ｼ繝・し繝ｳ繝・].map((t) => (
                <button key={t} onClick={() => setCat(t)} className={`px-3 py-2 rounded-xl text-sm shadow-sm ${cat === t ? "bg-emerald-600 text-white" : "bg-white"}`}>{t}</button>
              ))}
              <button onClick={() => setOpen(true)} className="ml-auto px-3 py-2 bg-emerald-600 text-white rounded-xl text-sm">{cat}繧定ｿｽ蜉</button>
            </div>

            {items.filter((x) => x.category === cat).map((m) => (
              <div key={m.id} className="bg-white rounded-2xl p-4 shadow-sm">
                <div className="flex items-center justify-between">
                  <div className="font-semibold">{m.name}</div>
                  <div className="flex items-center gap-2">
                    <button onClick={() => openEditMenu(m)} className="px-3 py-1 bg-neutral-100 rounded-lg text-sm">邱ｨ髮・/button>
                    <button onClick={() => removeMenu(m)} className="px-3 py-1 bg-red-600 text-white rounded-lg text-sm">蜑企勁</button>
                  </div>
                </div>
                <div className="mt-2 text-sm">1蛟句次萓｡・・b>・･{menuCost(m).toLocaleString()}</b></div>

                <div className="mt-3 space-y-2">
                  {m.lines.map((l) => (
                    <div key={l.id} className="grid grid-cols-12 gap-2 items-center">
                      <div className="col-span-4">
                        {l.type === "base"
                          ? (<div className="text-sm opacity-70">FY</div>)
                          : (<UnifiedDD value={composedValue(l)} onChange={(v) => handleSelectChange(m, l, v)} />)}
                      </div>
                      <div className="col-span-2">
                        <input
                          type="number"
                          className="border rounded-xl p-2 w-full"
                          value={l.qtyG}
                          onChange={(e) =>
                            setItems(items.map((x) =>
                              x.id === m.id
                                ? { ...x, lines: x.lines.map((a) => (a.id === l.id ? { ...a, qtyG: Number(e.target.value) } : a)) }
                                : x
                            ))
                          }
                        />
                      </div>
                      <div className="col-span-3 text-right text-sm">・･{rY(lineCost(l)).toLocaleString()}</div>
                      <div className="col-span-2 text-sm opacity-70">{l.type}</div>
                      <div className="col-span-1 text-right">
                        <button
                          className="text-red-600 text-sm"
                          onClick={() =>
                            setItems(items.map((x) =>
                              x.id === m.id
                                ? { ...x, lines: x.lines.filter((a) => a.id !== l.id) }
                                : x
                            ))
                          }
                        >
                          蜑企勁
                        </button>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-3">
                  <button onClick={() => addTypedLine(m)} className="px-3 py-1 bg-neutral-100 rounded-xl text-sm">陦瑚ｿｽ蜉</button>
                </div>
              </div>
            ))}

            <Modal open={open} onClose={() => setOpen(false)} title={`${cat}繧定ｿｽ蜉`}>
              <div className="grid gap-2">
                <label className="text-sm">繝｡繝九Η繝ｼ蜷・                  <input className="border rounded-xl p-2 w-full" value={name} onChange={(e) => setName(e.target.value)} />
                </label>
                <div className="flex justify-end gap-2 mt-3">
                  <button onClick={() => setOpen(false)} className="px-3 py-2 rounded-xl bg-neutral-100">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
                  <button onClick={create} className="px-3 py-2 rounded-xl bg-emerald-600 text-white">菴懈・</button>
                </div>
              </div>
            </Modal>

            <Modal open={menuEditOpen} onClose={() => setMenuEditOpen(false)} title="繝｡繝九Η繝ｼ蜷阪ｒ邱ｨ髮・>
              <div className="grid gap-2">
                <input className="border rounded-xl p-2 w-full" value={menuEditName} onChange={(e) => setMenuEditName(e.target.value)} />
                <div className="flex justify-end gap-2 mt-3">
                  <button onClick={() => setMenuEditOpen(false)} className="px-3 py-2 rounded-xl bg-neutral-100">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
                  <button onClick={saveEditMenu} className="px-3 py-2 rounded-xl bg-emerald-600 text-white">菫晏ｭ・/button>
                </div>
              </div>
            </Modal>
          </div>
        );
      }

      function IngredientManager({ ingredients, setIngredients }) {
        const [q, setQ] = useState("");
        const [open, setOpen] = useState(false);
        const [editing, setEditing] = useState(null);
        const [form, setForm] = useState({ name: "", category: "ingredient", price: "" });
        const list = ingredients.filter((i) => `${i.name} ${i.category}`.includes(q));
        const openNew = () => { setEditing(null); setForm({ name: "", category: "ingredient", price: "" }); setOpen(true); };
        const openEdit = (i) => { setEditing(i); setForm({ name: i.name, category: i.category, price: String(i.pricePerKg) }); setOpen(true); };
        const save = () => {
          const patch = { id: editing?.id ?? uid(), name: form.name.trim(), category: form.category.trim() || "ingredient", pricePerKg: Number(form.price || 0) };
          if (editing) {
            setIngredients(ingredients.map((x) => (x.id === editing.id ? { ...x, ...patch } : x)));
          } else {
            setIngredients([patch, ...ingredients]);
          }
          setOpen(false);
        };
        const removeItem = () => { if (!editing) return; setIngredients(ingredients.filter((x) => x.id !== editing.id)); setOpen(false); };

        return (
          <div className="px-4 pb-16">
            <div className="mb-2 flex items-center gap-2">
              <input className="border rounded-xl p-2 w-full" placeholder="譚先侭蜷・繧ｫ繝・ざ繝ｪ縺ｧ讀懃ｴ｢" value={q} onChange={(e) => setQ(e.target.value)} />
              <button onClick={openNew} className="px-3 py-2 bg-emerald-600 text-white rounded-xl text-sm">譁ｰ隕剰ｿｽ蜉</button>
            </div>
            <div className="space-y-2">
              {list.map((i) => (
                <div key={i.id} className="bg-white rounded-2xl p-3 shadow-sm">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-semibold">{i.name}</div>
                      <div className="text-xs opacity-70 mt-1">繧ｫ繝・ざ繝ｪ: {i.category}・慊･/kg: ・･{i.pricePerKg}</div>
                    </div>
                    <button onClick={() => openEdit(i)} className="px-3 py-1 bg-neutral-100 rounded-lg text-sm">邱ｨ髮・/button>
                  </div>
                </div>
              ))}
            </div>

            <Modal open={open} onClose={() => setOpen(false)} title={editing ? "譚先侭繧堤ｷｨ髮・ : "譚先侭繧定ｿｽ蜉"}>
              <div className="grid gap-2 text-sm">
                <label>譚先侭蜷・input className="border rounded-xl p-2 w-full" value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} /></label>
                <label>繧ｫ繝・ざ繝ｪ
                  <select className="border rounded-xl p-2 w-full" value={form.category} onChange={(e) => setForm({ ...form, category: e.target.value })}>
                    <option value="ingredient">ingredient</option>
                    <option value="sauce">sauce</option>
                    <option value="cream">cream</option>
                    <option value="granola">granola</option>
                    <option value="topping">topping</option>
                    <option value="container">container</option>
                  </select>
                </label>
                <label>萓｡譬ｼ(蜀・kg)<input type="number" className="border rounded-xl p-2 w-full" value={form.price} onChange={(e) => setForm({ ...form, price: e.target.value })} /></label>
                <div className="flex justify-between items-center gap-2 mt-2">
                  {editing && <button onClick={removeItem} className="px-3 py-2 rounded-xl bg-red-600 text-white">蜑企勁</button>}
                  <div className="ml-auto flex gap-2">
                    <button onClick={() => setOpen(false)} className="px-3 py-2 rounded-xl bg-neutral-100">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
                    <button onClick={save} className="px-3 py-2 rounded-xl bg-emerald-600 text-white">菫晏ｭ・/button>
                  </div>
                </div>
              </div>
            </Modal>
          </div>
        );
      }

      function Settings({ includeShipping, setIncludeShipping }) {
        return (
          <div className="px-4 pb-16">
            <div className="bg-white rounded-2xl p-4 shadow-sm">
              <div className="font-semibold mb-2">陦ｨ遉ｺ縺ｨ險育ｮ・/div>
              <div className="flex items-center gap-4 text-sm">
                <label className="inline-flex items-center gap-2">
                  <input type="checkbox" checked={includeShipping} onChange={(e) => setIncludeShipping(e.target.checked)} />
                  騾∵侭霎ｼ縺ｿ・井ｸ隕ｧ繝ｻ險育ｮ暦ｼ・                </label>
              </div>
            </div>
          </div>
        );
      }

      function Modal({ open, onClose, title, children }) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center">
            <div className="absolute inset-0 bg-black/30" onClick={onClose} />
            <div className="relative bg-white rounded-2xl shadow-lg w-[92%] max-w-md p-4">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">{title}</div>
                <button onClick={onClose} className="text-sm opacity-70">髢峨§繧・/button>
              </div>
              {children}
            </div>
          </div>
        );
      }

      function App() {
        const [tab, setTab] = usePersistentState("tab", "譫懃黄");
        const [fruits, setFruits] = usePersistentState("fruits", initialFruits);
        const [bases, setBases] = usePersistentState("bases", initialBases);
        const [includeShipping, setIncludeShipping] = usePersistentState("includeShipping", true);
        const [ingredients, setIngredients] = usePersistentState("ingredients", initialIngredients);
        const [items, setItems] = usePersistentState("menus", []);
        const [cat, setCat] = usePersistentState("menuCat", "逕溘・縺帙す繝ｪ繝ｼ繧ｺ");

        const fy = bases.find((b) => b.name === "繝輔Ο繝ｼ繧ｺ繝ｳ繝ｨ繝ｼ繧ｰ繝ｫ繝・);
        const fyG = useMemo(() => basePerG(fy), [fy]);
        const fyKg = rY(fyG * 1000);

        return (
          <div className="min-h-screen bg-neutral-50 text-neutral-900">
            <div className="p-4 pb-2">
              <div className="flex items-center justify-between">
                <div className="text-xl font-semibold">蜴滉ｾ｡繧｢繝励Μ・・VP・・/div>
                <div className="text-sm opacity-70">遞取栢繝ｻ蝗帶昏莠泌・ / 蜿ｯ鬟・蝗ｺ螳夐←逕ｨ</div>
              </div>
            </div>

            <div className="px-4 mb-3 flex gap-2 flex-wrap">
              {["譫懃黄", "繝吶・繧ｹ", "繝｡繝九Η繝ｼ", "縺昴・莉・, "險ｭ螳・].map((t) => (
                <button key={t} onClick={() => setTab(t)} className={`px-3 py-2 rounded-xl text-sm shadow-sm ${tab === t ? "bg-emerald-600 text-white" : "bg-white"}`}>{t}</button>
              ))}
            </div>

            {tab === "譫懃黄" && <FruitList fruits={fruits} setFruits={setFruits} includeShipping={includeShipping} fyPerG={fyG} />}
            {tab === "繝吶・繧ｹ" && <BaseEditor bases={bases} setBases={setBases} fyKg={fyKg} />}
            {tab === "繝｡繝九Η繝ｼ" && <MenuEditor fruits={fruits} fyPerG={fyG} ingredients={ingredients} items={items} setItems={setItems} cat={cat} setCat={setCat} />}
            {tab === "縺昴・莉・ && <IngredientManager ingredients={ingredients} setIngredients={setIngredients} />}
            {tab === "險ｭ螳・ && <Settings includeShipping={includeShipping} setIncludeShipping={setIncludeShipping} />}
          </div>
        );
      }

      // React 18 縺ｮ createRoot 縺ｧ繝槭え繝ｳ繝・      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
      // ===== 縺薙％縺ｾ縺ｧ =====
    </script>
  </body>
</html>
